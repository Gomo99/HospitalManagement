@using HospitalManagement.ViewModel
@model ChangePasswordViewModel

@{
    ViewData["Title"] = "Change Password";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-warning text-white py-3">
                    <h3 class="text-center mb-0">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h3>
                </div>
                <div class="card-body p-4">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form asp-action="ChangePassword" method="post" id="changePasswordForm">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label asp-for="CurrentPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>Current Password *
                            </label>
                            <div class="input-group">
                                <input asp-for="CurrentPassword" type="password" class="form-control"
                                       placeholder="Enter current password" id="currentPassword" />
                                <button class="btn btn-outline-secondary" type="button"
                                        id="toggleCurrentPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="CurrentPassword" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="NewPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>New Password *
                            </label>
                            <div class="input-group">
                                <input asp-for="NewPassword" type="password" class="form-control"
                                       placeholder="Enter new password" id="newPassword" />
                                <button class="btn btn-outline-secondary" type="button"
                                        id="toggleNewPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Must be at least 8 characters with uppercase, lowercase, and number
                            </small>
                            <div id="passwordStrength" class="mt-2">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="strengthText">Password strength</small>
                            </div>
                            <span asp-validation-for="NewPassword" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ConfirmNewPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>Confirm New Password *
                            </label>
                            <input asp-for="ConfirmNewPassword" type="password" class="form-control"
                                   placeholder="Confirm new password" />
                            <span asp-validation-for="ConfirmNewPassword" class="text-danger small"></span>
                            <div id="passwordMatch" class="mt-2"></div>
                        </div>

                        <div class="d-grid gap-2 mb-3">
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="fas fa-save me-2"></i>Update Password
                            </button>
                            <a asp-action="ViewProfile" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Profile
                            </a>
                        </div>

                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>Password Requirements:
                            </h6>
                            <ul class="mb-0">
                                <li>Minimum 8 characters</li>
                                <li>At least one uppercase letter</li>
                                <li>At least one lowercase letter</li>
                                <li>At least one number</li>
                                <li>Cannot be the same as current password</li>
                            </ul>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toggle password visibility
        const toggleButtons = [
            { button: 'toggleCurrentPassword', input: 'currentPassword' },
            { button: 'toggleNewPassword', input: 'newPassword' }
        ];

        toggleButtons.forEach(item => {
            document.getElementById(item.button).addEventListener('click', function() {
                const input = document.getElementById(item.input);
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });
        });

        // Password strength indicator
        document.getElementById('newPassword').addEventListener('input', function() {
            const password = this.value;
            const strength = checkPasswordStrength(password);
            const progressBar = document.querySelector('#passwordStrength .progress-bar');
            const strengthText = document.getElementById('strengthText');

            progressBar.style.width = strength.percentage + '%';
            progressBar.className = 'progress-bar ' + strength.class;
            strengthText.textContent = strength.text;
            strengthText.className = 'text-' + strength.textClass;
        });

        // Confirm password match
        document.getElementById('ConfirmNewPassword').addEventListener('input', function() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = this.value;
            const matchDiv = document.getElementById('passwordMatch');

            if (confirmPassword === '') {
                matchDiv.innerHTML = '';
                return;
            }

            if (newPassword === confirmPassword) {
                matchDiv.innerHTML = '<small class="text-success"><i class="fas fa-check-circle me-1"></i>Passwords match</small>';
            } else {
                matchDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times-circle me-1"></i>Passwords do not match</small>';
            }
        });

        function checkPasswordStrength(password) {
            let score = 0;
            let text = 'Weak';
            let textClass = 'danger';
            let progressClass = 'bg-danger';
            let percentage = 0;

            if (password.length >= 8) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;

            switch(score) {
                case 0:
                case 1:
                    text = 'Very Weak';
                    textClass = 'danger';
                    progressClass = 'bg-danger';
                    percentage = 20;
                    break;
                case 2:
                    text = 'Weak';
                    textClass = 'danger';
                    progressClass = 'bg-danger';
                    percentage = 40;
                    break;
                case 3:
                    text = 'Fair';
                    textClass = 'warning';
                    progressClass = 'bg-warning';
                    percentage = 60;
                    break;
                case 4:
                    text = 'Good';
                    textClass = 'info';
                    progressClass = 'bg-info';
                    percentage = 80;
                    break;
                case 5:
                    text = 'Strong';
                    textClass = 'success';
                    progressClass = 'bg-success';
                    percentage = 100;
                    break;
            }

            return {
                text: text,
                textClass: textClass,
                class: progressClass,
                percentage: percentage
            };
        }

        // Form validation
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('ConfirmNewPassword').value;

            if (currentPassword === newPassword) {
                e.preventDefault();
                alert('New password cannot be the same as current password.');
                return;
            }

            if (newPassword !== confirmPassword) {
                e.preventDefault();
                alert('New password and confirmation do not match.');
                return;
            }
        });
    </script>
}